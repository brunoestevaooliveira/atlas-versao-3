
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Regras para a coleção 'users'
    match /users/{userId} {
      // Qualquer um pode ler perfis (para ver nomes de quem reportou, etc.)
      allow read: if true;
      // Um usuário só pode criar ou atualizar seu próprio perfil.
      allow create, update: if request.auth.uid == userId;
      // Ninguém pode deletar perfis por enquanto.
      allow delete: if false;
    }

    // Regras para a coleção 'issues'
    match /issues/{issueId} {
      // Qualquer um pode ler as ocorrências para ver no mapa e dashboards.
      allow read: if true;
      // Apenas usuários logados podem criar novas ocorrências.
      allow create: if request.auth != null;

      // A permissão de atualização é dividida:
      // 1. Um admin pode atualizar qualquer coisa.
      // 2. Um usuário comum (logado) só pode atualizar os campos 'upvotes' e 'comments'.
      allow update: if (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin') ||
                     (request.auth.uid != null && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['upvotes', 'comments']));

      // Apenas um admin pode excluir uma ocorrência.
      allow delete: if get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
  }
}
